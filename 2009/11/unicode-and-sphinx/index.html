<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Unicode and Sphinx | Ryan Eby</title>
<meta name=keywords content>
<meta name=description content="I&rsquo;m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.
The Sphinx I&rsquo;m referring to is the indexing/search programthat works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.">
<meta name=author content>
<link rel=canonical href=https://ryaneby.com/2009/11/unicode-and-sphinx/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ryaneby.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://ryaneby.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://ryaneby.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://ryaneby.com/apple-touch-icon.png>
<link rel=mask-icon href=https://ryaneby.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Unicode and Sphinx">
<meta property="og:description" content="I&rsquo;m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.
The Sphinx I&rsquo;m referring to is the indexing/search programthat works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ryaneby.com/2009/11/unicode-and-sphinx/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2009-11-21T00:00:00+00:00">
<meta property="article:modified_time" content="2009-11-21T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Unicode and Sphinx">
<meta name=twitter:description content="I&rsquo;m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.
The Sphinx I&rsquo;m referring to is the indexing/search programthat works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://ryaneby.com/posts/"},{"@type":"ListItem","position":3,"name":"Unicode and Sphinx","item":"https://ryaneby.com/2009/11/unicode-and-sphinx/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unicode and Sphinx","name":"Unicode and Sphinx","description":"I\u0026rsquo;m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.\nThe Sphinx I\u0026rsquo;m referring to is the indexing/search programthat works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.","keywords":[],"articleBody":"I’m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.\nThe Sphinx I’m referring to is the indexing/search programthat works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.\nYou can convert tables and all the fields within the table with the command (from pythoneer):\nALTER TABLE tbl_name CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci; You could also do utf8_general_ci. From what I’ve picked up online is that the unicode_ci supports expansions/ligatures while the general doesn’t which can affect sorting. However, the docs say the the tradeoff is speedin some operations. Both lack some character support versus the actual Unicode Collation Algorithm.\nYou will want to set your index definition to have:\ncharset_type = utf-8 While the docs mostly just mention that I highly recommend adding the following to your source definition:\nsql_query_pre = SET CHARACTER_SET_RESULTS=utf8 sql_query_pre = SET NAMES utf8 While you might think that having your tables in utf8 collation, mysql set to default to it and php encoding in utf8 would be enough, if the client doesn’t specify that it is doing utf8 mysql will store it in whatever encoding it thinks it is getting. I battled with php configs to try to ensure all machines modifying the tables were talking the same but you’ll save yourself the trouble by defining this here and also in your scripts that write to the tables.\nAs stated above I’d recommend doing a SET NAMES utf8 in front of your queries inserting data into mysql. This again may be poor setup on my part but it helps rule out different client configurations and probably makes it more portable. I found Gentoo by default seems to do fine, Debian hit or miss. Adding the SET made it work where ever I tried.\nSome documentation stated I should wipe database if it previously had other encodings. I found this unnecessary and just inserted the data with UPDATE or REPLACE INTO and had no issues.\nWhile stop words and similar allow you to use external files for the list, it appears character folding needs the list to be in the config itself. At least I haven’t been able to get an include file to work. I’d be interested in knowing otherwise. Depending on the languages you have you may want to generate a list of the codes present in your dataset. Otherwise you can find some tables to try out here:\nSome reported that Sphinx can have issues with long lines in the config so you may need to break up the lines with \\ characters. Your list should also include “0..9, a..z, A..Z-a..z” in it as you are overriding the default list.\nAnother thing to note with Sphinx is that many changes to the sphinx.conf requires a restart of searchd. With the modification of the folding table you’ll probably want to do this. Restart searchd and then do your indexer run for your indexes.\nTry out some searches with keywords/characters and watch the query log. If the character folding is working then you should see the encoded characters in the query log. If they are missing or replaced by spaces then the characters aren’t matching up with your folding table. Try to find the character, add it to your list, restart searchd and reindex. Sphinx defaults to not accepting characters that are not in the charset_table list. The query log is the easiest point to diagnose this at.\nThe last step is of course to make sure your web pages are served in a proper encoding so browsers render it properly.\nAgain this isn’t in depth but hopefully will help those messing with Sphinx.\n","wordCount":"652","inLanguage":"en","datePublished":"2009-11-21T00:00:00Z","dateModified":"2009-11-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://ryaneby.com/2009/11/unicode-and-sphinx/"},"publisher":{"@type":"Organization","name":"Ryan Eby","logo":{"@type":"ImageObject","url":"https://ryaneby.com/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://ryaneby.com accesskey=h title="Ryan Eby (Alt + H)">Ryan Eby</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://ryaneby.com/archives/ title=archive>
<span>archive</span>
</a>
</li>
<li>
<a href=https://ryaneby.com/about/ title=about>
<span>about</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://ryaneby.com>Home</a>&nbsp;»&nbsp;<a href=https://ryaneby.com/posts/>Posts</a></div>
<h1 class=post-title>
Unicode and Sphinx
</h1>
<div class=post-meta><span title="2009-11-21 00:00:00 +0000 UTC">November 21, 2009</span>&nbsp;·&nbsp;4 min
</div>
</header>
<div class=post-content><p>I&rsquo;m not an expert with unicode and ran into various problems in getting Sphinx up and running with bib data for SOPAC2. Below is an overview of what I ended up doing to solve it. There are probably better ways of doing it and if so please share.</p>
<p>The Sphinx I&rsquo;m referring to is the indexing/search program that works well with MySQL. The case below is using the stock searchd/indexer interface and not the mysql engine which is probably different.</p>
<p>You can convert tables and all the fields within the table with the command (from pythoneer):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> tbl_name <span style=color:#66d9ef>CONVERT</span> <span style=color:#66d9ef>TO</span> <span style=color:#66d9ef>CHARACTER</span> <span style=color:#66d9ef>SET</span> utf8 <span style=color:#66d9ef>COLLATE</span> utf8_unicode_ci;</code></pre></div>
<p>You could also do utf8_general_ci. From what I&rsquo;ve picked up online is that the unicode_ci supports expansions/ligatures while the general doesn&rsquo;t which can affect sorting. However, the docs say the the tradeoff is speed in some operations. Both lack some character support versus the actual Unicode Collation Algorithm.</p>
<p>You will want to set your index definition to have:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql>charset_type <span style=color:#f92672>=</span> utf<span style=color:#f92672>-</span><span style=color:#ae81ff>8</span></code></pre></div>
<p>While the docs mostly just mention that I highly recommend adding the following to your source definition:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql>sql_query_pre <span style=color:#f92672>=</span> <span style=color:#66d9ef>SET</span> CHARACTER_SET_RESULTS<span style=color:#f92672>=</span>utf8
sql_query_pre <span style=color:#f92672>=</span> <span style=color:#66d9ef>SET</span> NAMES utf8</code></pre></div>
<p>While you might think that having your tables in utf8 collation, mysql set to default to it and php encoding in utf8 would be enough, if the client doesn&rsquo;t specify that it is doing utf8 mysql will store it in whatever encoding it thinks it is getting. I battled with php configs to try to ensure all machines modifying the tables were talking the same but you&rsquo;ll save yourself the trouble by defining this here and also in your scripts that write to the tables.</p>
<p>As stated above I&rsquo;d recommend doing a SET NAMES utf8 in front of your queries inserting data into mysql. This again may be poor setup on my part but it helps rule out different client configurations and probably makes it more portable. I found Gentoo by default seems to do fine, Debian hit or miss. Adding the SET made it work where ever I tried.</p>
<p>Some documentation stated I should wipe database if it previously had other encodings. I found this unnecessary and just inserted the data with UPDATE or REPLACE INTO and had no issues.</p>
<p>While stop words and similar allow you to use external files for the list, it appears character folding needs the list to be in the config itself. At least I haven&rsquo;t been able to get an include file to work. I&rsquo;d be interested in knowing otherwise. Depending on the languages you have you may want to generate a list of the codes present in your dataset. Otherwise you can find some tables to try out here:</p>
<p>Some reported that Sphinx can have issues with long lines in the config so you may need to break up the lines with \ characters. Your list should also include &ldquo;0..9, a..z, A..Z->a..z&rdquo; in it as you are overriding the default list.</p>
<p>Another thing to note with Sphinx is that many changes to the sphinx.conf requires a restart of searchd. With the modification of the folding table you&rsquo;ll probably want to do this. Restart searchd and then do your indexer run for your indexes.</p>
<p>Try out some searches with keywords/characters and watch the query log. If the character folding is working then you should see the encoded characters in the query log. If they are missing or replaced by spaces then the characters aren&rsquo;t matching up with your folding table. Try to find the character, add it to your list, restart searchd and reindex. Sphinx defaults to not accepting characters that are not in the charset_table list. The query log is the easiest point to diagnose this at.</p>
<p>The last step is of course to make sure your web pages are served in a proper encoding so browsers render it properly.</p>
<p>Again this isn&rsquo;t in depth but hopefully will help those messing with Sphinx.</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://ryaneby.com/2009/11/describing-everything-open-web-standards-and-classi%C3%AFcation/>
<span class=title>« Prev Page</span>
<br>
<span>Describing Everything - Open Web standards and classiï¬cation</span>
</a>
<a class=next href=https://ryaneby.com/2009/06/gutter-garden/>
<span class=title>Next Page »</span>
<br>
<span>Gutter Garden</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>